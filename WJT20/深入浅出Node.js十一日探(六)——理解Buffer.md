
# 深入浅出Node.js十一日探(六)——理解Buffer #

## 目录 ##

## Buffer结构 ##

Buffer 是一个像 Array 的对象，但它主要用于操作字节。

### 模块结构 ###

Buffer 是一个典型的 JavaScript 与 C++ 结合的模块，它将性能相关部分用 C++ 实现，将非性能相关部分用 JavaScript 实现。

Node.js 在进程启动时就已经加载完了 Buffer，并将其放到全局对象上，所以在使用 Buffer 时，无需通过`require()`即可直接使用。

### Buffer对象 ###

Buffer 对象由若干个16进制的两位数元素构成(类似数组)，示例代码如下:

```js
var str = 'Hello world';
var buf = new Buffer(str, 'utf-8');
console.log(buf); // => <Buffer 48 65 6c 6c 6f 20 77 6f 72 6c 64>
console.log(buf.length); // => 11
console.log(buf[0]); // => 72
```

不同编码的字符串占用的元素个数各不相同，中文字符在 UTF-8 编码下占用3个元素，字母和半角标点符号占用1个元素。Buffer 和 Array 一样，可以访问 length 属性得到长度，也可以通过下标访问元素，在构造对象时也十分相似。

在用下标访问元素时你会发现得到的是一个0到255的随机值。同样，我们可以通过下标对某个元素进行赋值，给元素赋的值如果小于0，就将该值逐次加256，直到得到一个0到255之间的整数。如果得到的数值大于255，就逐次减256，直到得到0~255区间内的数值; 如果是小数，舍弃小数部分，只保留整数部分。

### Buffer内存分配 ###

Buffer 对象的内存分配不是在V8的堆内存中，而是在 Node.js 的 C++ 层面实现内存的申请的。因为处理大量的字节数据不能采用需要一点内存就向操作系统申请一点内存的方式，这可能造成大量的内存申请的系统调用，对操作系统有一定压力。为此 Node.js 在内存的使用上应用的是在 C++ 层面申请内存、在 JavaScript 中分配内存的策略。

---

```
ID         : 132
DATE       : 2019/06/09
AUTHER     : WJT20
TAG        : Node.js
```
